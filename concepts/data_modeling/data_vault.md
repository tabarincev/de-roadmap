# List of content
- [Что такое Data Vault 2.0 ?]()

## Что такое Data Vault 2.0 ?

> **Data Vault 2.0** — гибкая методология для хранения больших объёмов данных и отслеживания их изменений во времени.

### Основные характеристики:
* обеспечивает максимально возможную параллельную загрузку;
* позволяет масштабировать крупные реализации без серьёзной перестройки (за счёт усложнения взаимосвязей данных и структур таблиц);
* представляет собой набор уникально связанных нормализованных таблиц, которые:
  * содержат детальные данные;
  * отслеживают историю изменений;
  * поддерживают одну или несколько функциональных областей бизнеса.

### Архитектура и применение

> Data Vault — гибридный подход, объединяющий преимущества:
* третьей нормальной формы (3NF);
* схемы «Звезда» (Star schema).

**Назначение:**
* удовлетворение потребностей хранилищ данных (data warehouse);
* может использоваться как Operational Data Store (ODS) при наличии соответствующих аппаратных средств и ядра базы данных.

**Преимущества перед 3NF и схемой «Звезда»:**
* обработка больших наборов детальных данных с меньшими физическими объёмами.

### Структура и методы моделирования

В модели Data Vault присутствуют структуры, соответствующие традиционным определениям схемы «Звезда» и 3NF, включая:
* измерения;
* связи «многие ко многим»;
* стандартные табличные структуры.

**Отличия Data Vault:**
* особое представление отношений;
* специфическое структурирование полей;
* хранение детальных данных, основанных на времени.

**Используемые методы моделирования данных:**
* отношения «многие ко многим»;
* ссылочная целостность;
* минимально избыточный набор данных;
* информационные хабы с ключевыми бизнес-функциями.

Эти методы делают модель данных Data Vault гибкой, расширяемой и согласованной. Подход к построению модели данных — итеративный, он предоставляет архитекторам данных и деловым пользователям платформу для построения хранилища данных на компонентной основе.


## Компоненты

Для сохранения простоты и изящества дизайна используется минимальное количество типов сущностей:
* Хаб (Hub);
* Связь (Link);
* Спутник (Satellite).

Ю Дизайн Data Vault сосредоточен вокруг функциональных областей бизнеса, представленных первичным ключом сущности. Сущность «Связь (Link)» обеспечивает транзакционную интеграцию между компонентами. Сущность «Спутник (Satellite)» предоставляет контекст первичного ключа Хаба. Каждая сущность предназначена для обеспечения максимальной гибкости и масштабируемости, сохраняя при этом большинство традиционных навыков моделирования данных.

### Сущность — Хаб (Hub)

`Хабы` — отдельные таблицы, содержащие как минимум уникальный список бизнес-ключей. Эти ключи используются бизнесом в повседневных операциях, например:
* номер счёта-фактуры;
* номер сотрудника;
* номер клиента;
* номер компонента;
* VIN (идентификационный номер транспортного средства).

Другие атрибуты хаба включают:
* суррогатный ключ (`Surrogate Key`) — необязательный компонент, может быть смарт-ключом или порядковым номером;
* временная отметка даты загрузки (`Load Date Time Stamp`) — регистрирует, когда ключ впервые был загружен в хранилище;
* источник данных (`Record Source`) — регистрирует исходную систему, используется для обратной трассировки данных.

Например, если требуется собирать номера клиентов по всей компании, в хабе будут храниться все варианты номеров (например, 12345 из бухгалтерии и AC12345 из отдела контрактов).

### Сущность — Связь (Link)

Сущности «Связь» — физическое представление связей «многие ко многим» третьей нормальной формы (3NF). Они представляют отношения или транзакции между двумя или более компонентами бизнеса.

Атрибуты сущности «Связь»:
* суррогатный ключ (Surrogate Key) — необязательный компонент, используется, если связано более двух компонентов или если составной первичный ключ может привести к проблемам с производительностью;
* ключи хабов (от 1-го до N-го) — мигрируют в сущность «Связь», образуя составной ключ и представляя взаимодействия между хабами;
* временная отметка даты загрузки (Load Date Time Stamp) — регистрирует, когда связь/транзакция впервые была создана в хранилище;
* источник данных (Record Source) — регистрирует исходную систему, используется для обратной трассировки данных.

Эта техника моделирования разработана для хранилищ данных, а не для OLTP-систем.

### Сущность — Спутник (Satellite)

Сущности «Спутник» содержат контекстную (описательную) информацию ключа хаба. Структура должна быть способна хранить новые или изменённые детальные данные.

Обязательные атрибуты спутника:
* первичный ключ спутника — мигрирует из хаба или связи;
* временная отметка даты загрузки (`Load Date Time Stamp`) — регистрирует, когда контекстная информация стала доступна в хранилище;
* последовательный суррогатный номер (необязательное поле) — используется для сущностей с несколькими значениями (например, адрес выставления счетов и домашний адрес) или для поддержки подгрупп и порядка;
* источник данных (Record Source) — регистрирует исходную систему, используется для обратной трассировки данных.

Спутник наиболее близок к медленно меняющимся измерениям 2-го типа. Его функция — обеспечение описательного контекста экземплярам хабов или связей. Например, он может хранить информацию о том, что VIN 1234567 вчера был синим грузовиком Тойота, а сегодня — красным.


## Плюсы и минусы
| Плюсы | Минусы |
|------------------|-------------------|
| Интуитивно понятная структура, которая позволяет сформировать витрины под любые потребности бизнеса | Большое количество таблиц и JOIN'ов, которые повышают риск ошибок и замедляют выполнение запросов относительно традиционных DWH, где таблицы более денормализованы |
| Простой доступ к анализу — первые верхнеуровневые отчеты доступны уже после загрузки Хабов и Связей | Сложность выстраивания проверки данных из-за большого количества сущностей и сложных связей между ними |
| Можно независимо разрабатывать смежные источники и легко заменять их, так как данные почти полностью отвязаны друг от друга | Методология хорошо задокументирована, но требует от специалиста богатого абстрактного мышления, дополнительных навыков и знаний особенностей работы специфических функций, например хеширования |



## Решение архитектурных недостатков хранилищ данных
3NF и схема Звезда, когда они используются для хранилищ данных предприятия, могут причинять бизнесу боль, потому что они не были изначально предназначены для целей хранилищ. Есть проблемы, связанные с масштабируемостью, гибкостью и степенью детализации данных, интеграцией и объемом. Объем информации, которую хранилища обязаны хранить сегодня, увеличивается по экспоненте каждый год. Приложения CRM, SCM, ERP и все другие большие системы приводят к увеличению объемов информации в хранилищах. Существующие модели данных, основанные на 3NF или схеме Звезда, оказывается, трудно изменять, поддерживать и анализировать, не говоря уже о резервном копировании и восстановлении.

В ранее приведенном примере мы реализовали хранилище Data Vault, состоящее из единственного Хаба и нескольких Спутников и ограниченное рамками хранения истории о транспортных средствах и соответствующих им атрибутах. Если год спустя бизнес захочет видеть в хранилище контракты по этим транспортным средствам, то необходимые Хабы и Связи могут быть легко добавлены. Не беспокойтесь о степени детализации. Этот тип модели расширяем верх и вширь (реализация «снизу вверх», проектирование «сверху вниз»). Конечный результат всегда строго фундаментирован и может создаваться итерационным подходом к разработке.

Другой пример – сильные возможности сущности Связь. Предположим, что сегодня компания, продающая продукцию, имеет Хаб Продукты, Хаб Счет и Связь между ними. Затем компания решает продавать услуги. Модель данных позволяет ввести новый Хаб Услуги, заполнить дату окончания в продуктовые Связи и начать новую Связь между услугами и счетами. Никакие данные не потеряны, и все данные, накопленные в течение долгого времени сохранены и отражают изменения бизнеса. Это лишь одна из многочисленных возможностей для обработки подобной ситуации.

Большой объем данных приводит к проблемам с запросами, особенно это касается схем Звезда, но в меньшей степени и 3NF. Нарушается производительность запросов при больших объемах информации в согласованных измерениях и согласованных таблицах фактов. Часто требуется делать партиционирование и непрерывно переделывать структуры, чтобы предоставить дополнительную степень детализации бизнес пользователям. Это обеспечивает кошмар обслуживания и управления. Перезагрузка постоянно меняющихся звезд является трудной задачей – не говоря уже о попытке выполнить это с большим объемом данных (свыше 1 Терабайт, например). Data Vault уходит корнями в математические основы нормализованной модели данных. Сокращения избыточности и учет темпов изменения наборов данных способствует повышению производительности и простоте в управлении. Архитектура Data Vault не ограничивается применением какой-либо одной платформы. Архитектура так же позволяет использовать распределенный взаимосвязанный набор информации.

Хранилищам данных часто приходится дело с утверждением: «То, что я (пользователь) дам Вам – это никогда не приходит из исходных систем». И они предоставляют крупноформатную таблицу со своей ежедневно поддерживаемой интерпретацией информации. Другими словами: «Я (заказчик) хочу видеть все номера VIN, которые начинаются с "X", сгруппированными под названием "BIG TRUCKS" ("БОЛЬШИЕ ГРУЗОВИКИ")». В Data Vault предусмотрена такая возможность с помощью Набора Пользовательских Группировок (User Grouping Set). Это еще один Хаб (с названием Big Trucks) со Спутником, описывающим номера VIN, группируемые под этим лейблом, и Связь с номерами VIN. Таким образом, сохранены оригинальные данные из исходной системы, в то же время можно получить информацию в манере, соответствующей пользовательским потребностям. Когда все будет сказано и сделано, хранилище данных является успешным, так как оно отвечает потребностям пользователей.


## Основы архитектуры Data Vault
Архитектура уходит корнями в математику сокращения избыточности. Спутники предназначены только для хранения дельты или изменившейся информации. Если один из спутников начинает быстро расти, очень легко создать два новых спутника и запустить процесс, разделяющий дельту; процесс, который будет разделять информацию в два новых спутника, каждый процесс выполняет другой дельта-процесс перед вставкой новых строк. Этот процесс может сократить процент дублирования колоночных данных до минимума. Это приравнивается к использованию меньшего объема хранения. Спутники по своей природе могут быть очень длинными, и в большинстве случаев узкими (имеют не много столбцов). Для сравнения, измерения 2-го типа могут реплицировать данные во многих столбцах, делать копии информации снова и снова, а также создавая новые ключи.

Хабы хранят по одному экземпляру бизнес ключа. Бизнес ключи, как правило, имеют очень низкую склонность к изменениям. Поэтому суррогатные ключи отображаются один к одному на бизнес ключи (если используются суррогаты) и никогда не меняются. Первичный ключ Хаба (независимо от типа - бизнес или суррогатный) является единственным компонентом информации, реплицированным между Спутниками и Связями. Поэтому Спутники всегда привязываются непосредственно к бизнес ключу. Таким образом, Спутникам отводится роль описывать бизнес ключи на наиболее доступном детальном уровне. Это обеспечивает основу для развития контекста, описывающего бизнес.

Другим уникальным результатом Data Vault является возможность динамически представлять отношения. Отношения создаются структурой Связей сразу же как «ассоциированные» бизнес ключи поступают из источника данных. Эта связь существует, пока они не датированы датой окончания (в Спутнике), либо не удалены из набора данных полностью. Тот факт, что эти отношения представлены таким образом, открывает новые возможности в области динамического создания отношений. Если в результате интеллектуального анализа данных обнаружены новые отношения между двумя хабами (или их контекстом), то новые Связи могут быть сформированы автоматически.

Кроме того, структуры Связи и информация могут быть отмечены конечной датой или удалены, когда они утратят свою актуальность. Например: сегодня компания продает продукцию, и имеет таблицу связи между продуктами и счетами-фактурами. Завтра, они начинают продавать услуги. Это очень просто реализуется, путем создания Хаба «Услуги» и связи между счетами и услугами, затем все отношения между товарами и счетами-фактурами датируются как оконченные. В этом примере, процесс изменения модели данных можно начать исследовать с программной точки зрения. Если это автоматизировать, то можно будет динамически изменять и адаптировать структуру хранилища данных, чтобы удовлетворить потребности деловых пользователей.

Темпы изменения и сокращение избыточности наряду с гибкостью потенциально неограниченных динамических изменений отношений формируют мощную основу. Эти слагаемые открывают двери применению структур Data Vault для множества различных целей.

https://youtu.be/fNGIOb8SJvU?t=1404
