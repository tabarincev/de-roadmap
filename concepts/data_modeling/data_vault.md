# List of content
- [Что такое Data Vault 2.0 ?]()
- [Компоненты]()
- [Решение архитектурных недостатков хранилищ данных]()

## Что такое Data Vault 2.0 ?

`Data Vault` – набор уникально связанных нормализованных таблиц, содержащих детальные данные, отслеживающих историю изменений и предназначенных для поддержки одной или нескольких функциональных областей бизнеса.

> Гибридный подход, обобщающий лучшие свойства третьей нормальной формы (`3NF`) и схемы Звезда (`Star schema`)

Архитектура Data Vault предназначена для удовлетворения потребностей хранилищ данных (data warehouse), не путайте с витринами данных (data mart). Также может исполнять вторую роль – `Operational Data Store (ODS)`, при условии применения для поддержки этого правильных аппаратных средств и ядра базы данных. Data Vault может обрабатывать большие наборы детальных данных используя меньшие физические объемы, по сравнению и с 3-ей нормальной формой (`3NF`), и по сравнению со схемой Звезда (`Star schem`a). `Data Vault` имеет твердый «фундамент», основанный на математических принципах, которые поддерживают нормализованные модели данных. В модели Data Vault содержаться структуры, которые знакомые и соответствуют традиционным определениям схемы звезда и 3NF, включая: измерения, связи многие ко многим и стандартные табличные структуры. Различия заключаются в представлении отношений, структурировании полей и хранении детальных данных, основанных на времени. Методы моделирования, встроенные в Data Vault, испытаны годами проектирования и тестирования в самых различных сценариях, а также твердым подходом к хранилищам данных.

Data Vault – определение нормализации моделей данных для хранилищ. Ее сила заключается в использовании определенной структуры, из которой строится модель. Data Vault использует некоторые из следующих методов моделирования данных: отношения многие ко многим, ссылочная целостность, минимально избыточный набор данных и информационные хабы с ключевыми бизнес-функциями. Эти методы делают модель данных Data Vault гибкой, расширяемой и согласованной. Подход к построению модели данных является итеративным, предоставляющим архитекторам данных и деловым пользователям платформу для построения хранилища данных на компонентной основе (см. статью Билла Инмона: Data Mart Does Not Equal Data Warehouse, DMReview.com).

## Компоненты
Для того чтобы сохранить дизайн простым и изящным, используется минимальное количество типов сущностей:
- `Хаб (Hub)`
- `Связь (Link)`
- `Спутник (Satellite)`

> Дизайн `Data Vault` сосредоточен вокруг функциональных областей бизнеса представленных первичным ключом сущности` Хаб (Hub)`. Сущность `Связь (Link)` обеспечивает транзакционную интеграцию между Хабами. Сущность `Спутник (Satellite)` предоставляет контекст первичного ключа Хаба. Каждый сущность предназначена для обеспечения максимальной гибкости и масштабируемости, сохраняя при этом большинство традиционных навыков моделирования данных.

### Сущность - Хаб (Hub)
Хабы (Hub), являются отдельными таблицами, содержащими как минимум уникальный список бизнес ключей. Эти ключи - то, что бизнес используют в повседневных операциях. Например, номер счета-фактуры, номер сотрудника, номер клиента, номер компонента и VIN (vehicle identification number - идентификационный номер транспортного средства). Если бизнес потеряет ключ, то они потеряют ссылку на контекст или окружающую информацию. Другие атрибуты Хаба включают:

- Суррогатный ключ (Surrogate Key) – необязательный компонент, возможно смарт-ключ или порядковый номер.
- Временная отметка даты загрузки (Load Date Time Stamp), регистрирующая, когда ключ впервые был загружен в хранилище.
- Источник данных (Record Source) – регистрация исходной системы, используется для обратной трассировки (отслеживания) данных.

Например, требования заключаются в том, чтобы собирать номера клиентов по всей компании. Бухгалтерия может иметь номер клиента, представленный в цифровом стиле (12345) а отдел контрактов может иметь тот же номер клиента с буквенной приставкой (AC12345). В данном случае, представление номера клиента в Хабе будет алфавитно-цифровым и с максимальной длинной, чтобы хранить все номера клиента из разных функциональных областей бизнеса. В Хабе будет два вхождения: 12345 и AC12345, каждое будет иметь свой собственный источник данных: один из бухгалтерского учета и один из отдела контрактов. Очевидно, предпочтительнее было бы выполнить очистку и сопоставление этих номеров и интегрировать их в одну запись. Но это выходит за рамки данного документа. Первичный ключ Хаба всегда мигрирует из Хаба. Как только мы правильно идентифицируем бизнес посредством ключей (например, клиенты и счета), то могут быть построены сущности Связи.

### Сущность Связь (Link)
Сущности Связи (или просто Связи) – физическое представление связей "многие ко многим" третьей нормальной формы (3NF). Сущность Связь представляет отношения или транзакцию между двумя или более компонентами бизнеса (два или более бизнес ключа). Связь содержит следующие атрибуты:
- Суррогатный ключ (Surrogate Key) – необязательный компонент, возможно смарт-ключ или порядковый номер. Используются только, если существует более двух Хабов связанных этой Связью, или если составной первичный ключ может привести к проблемам производительности.
- Ключи Хабов: от 1-го Хаба до N-го Хаба – ключи Хабов мигрируют в сущность Связь, образуя составной ключ, и представляют взаимодействия и связи между Хабами.
- Временная отметка даты загрузки (Load Date Time Stamp), регистрирующая, когда связь/транзакция впервые была создана в хранилище.
- Источник данных (Record Source) – регистрация исходной системы, используется для обратной трассировки (отслеживания) данных.

Это – адаптация отношений «многие ко многим» третьей нормальной формы (3NF), решающая проблемы, связанные с масштабируемостью и гибкостью. Эта техника моделирования разработана для хранилищ данных, а не для OLTP систем. Имейте в виду, что некоторые из основополагающих правил для моделирования Data Vault будут перечислены в конце этого документа. С помощью только нескольких Хабов и Связей модель данных начнет описание потоков бизнеса (business flow). Следующий наш компонент должен объяснить: «когда?», «почему?», «что?», «где?» и «кто?» создал, как сделки, так и, собственно, ключевые объекты. Например, недостаточно знать, что есть некоторый VIN у транспортного средства, или что есть водитель номер 5. Заказчик хочет знать, что именно представляет собой определенный VIN (например, синяя Тойота, пикап, 4WD и т.д.), и что водителя номер 5 зовут Джейн, и что это и есть водитель автомобиля с конкретным VIN.

### Сущность Спутник (Satellite)
Сущности Спутники (или просто Спутники), являются контекстной (описательной) информацией ключа Хаба. Описание подвергается изменениям с течением времени, и поэтому структура Спутников должна быть способна хранить новые или измененные детальные данные. Значение VIN не должно меняться, но если ремонтная бригада, восстанавливая Тойоту, уберет верх и добавит трубчатый каркас (ролл-бар), машина не будет больше пикапом. Что делать, если Джейн продаст машину, кому-то еще, скажем, водителю под номером 6? Спутник состоит из следующих обязательных атрибутов:
- Первичный ключ Спутника: Первичный ключ Хаба или первичный ключ Связи – мигрирует в Спутник из Хаба или Связи.
Первичный ключ Спутника: Временная отметка даты загрузки (Load Date Time Stamp) – регистрация, когда информация контекстная стала доступна в хранилище (всегда вставляется новая строка).
- Первичный ключ Спутника (необязательное поле): Последовательный (sequence) суррогатный номер – используется для Спутников, которые имеют несколько значений (например, адрес выставление счетов и домашний адрес); или номер позиции строки, используется для поддержки подгрупп и порядка.
- Источник данных (Record Source) – регистрация исходной системы, используется для обратной трассировки (отслеживания) данных.

Спутник наиболее близок медленноменяющимся измерениям 2-го Типа в определении Ральфа Кимбалла. Он хранит изменения на детальном уровне, а его функция заключается в обеспечении описательного контекста экземплярам Хаба или Связи. Например, факт, что VIN 1234567 представлял собой синий грузовик Тойота вчера, а сегодня это – красный грузовик Тойота (перекрасили). Цвет может храниться в Спутнике автомобиля. Проектирование Спутников должно основываться на математических принципах сокращения избыточности данных и на скорости изменения данных. Например, если автомобиль арендуется, то дата доступности / аренды может меняться ежедневно, что гораздо чаще, чем скорость изменения цвета, шин или владельца. Проблема, решаемая Спутником, определяется следующим образом:

Автомобильное измерение может содержать более 160-ти атрибутов. Если используется 2-ой тип размерности, то при изменении цвета или замене шин, все 160 с лишним атрибутов должны копироваться в новую строку. Почему данные копируются, если остальная часть атрибутов меняется медленнее? При использовании измерений 1-го Типа или 3-го Типа можно частично или полностью потерять историю изменений. В таком случае проектировщик данных должен построить как минимум два Спутника: один с датами наличия автомобиля, второй, описывающий техническое обслуживание / комплектующие элементы. Если первый день арендует автомобиль клиент Дэн, а второй день – Джейн, то сущности Связи отвечают за представление этих отношений. Проектировщик данных может добавить к Связи один или несколько Спутников, которые представляют даты аренды (от / до), состояние транспортного средства и замечания со стороны арендатора.
Решение архите

## Решение архитектурных недостатков хранилищ данных
3NF и схема Звезда, когда они используются для хранилищ данных предприятия, могут причинять бизнесу боль, потому что они не были изначально предназначены для целей хранилищ. Есть проблемы, связанные с масштабируемостью, гибкостью и степенью детализации данных, интеграцией и объемом. Объем информации, которую хранилища обязаны хранить сегодня, увеличивается по экспоненте каждый год. Приложения CRM, SCM, ERP и все другие большие системы приводят к увеличению объемов информации в хранилищах. Существующие модели данных, основанные на 3NF или схеме Звезда, оказывается, трудно изменять, поддерживать и анализировать, не говоря уже о резервном копировании и восстановлении.

В ранее приведенном примере мы реализовали хранилище Data Vault, состоящее из единственного Хаба и нескольких Спутников и ограниченное рамками хранения истории о транспортных средствах и соответствующих им атрибутах. Если год спустя бизнес захочет видеть в хранилище контракты по этим транспортным средствам, то необходимые Хабы и Связи могут быть легко добавлены. Не беспокойтесь о степени детализации. Этот тип модели расширяем верх и вширь (реализация «снизу вверх», проектирование «сверху вниз»). Конечный результат всегда строго фундаментирован и может создаваться итерационным подходом к разработке.

Другой пример – сильные возможности сущности Связь. Предположим, что сегодня компания, продающая продукцию, имеет Хаб Продукты, Хаб Счет и Связь между ними. Затем компания решает продавать услуги. Модель данных позволяет ввести новый Хаб Услуги, заполнить дату окончания в продуктовые Связи и начать новую Связь между услугами и счетами. Никакие данные не потеряны, и все данные, накопленные в течение долгого времени сохранены и отражают изменения бизнеса. Это лишь одна из многочисленных возможностей для обработки подобной ситуации.

Большой объем данных приводит к проблемам с запросами, особенно это касается схем Звезда, но в меньшей степени и 3NF. Нарушается производительность запросов при больших объемах информации в согласованных измерениях и согласованных таблицах фактов. Часто требуется делать партиционирование и непрерывно переделывать структуры, чтобы предоставить дополнительную степень детализации бизнес пользователям. Это обеспечивает кошмар обслуживания и управления. Перезагрузка постоянно меняющихся звезд является трудной задачей – не говоря уже о попытке выполнить это с большим объемом данных (свыше 1 Терабайт, например). Data Vault уходит корнями в математические основы нормализованной модели данных. Сокращения избыточности и учет темпов изменения наборов данных способствует повышению производительности и простоте в управлении. Архитектура Data Vault не ограничивается применением какой-либо одной платформы. Архитектура так же позволяет использовать распределенный взаимосвязанный набор информации.

Хранилищам данных часто приходится дело с утверждением: «То, что я (пользователь) дам Вам – это никогда не приходит из исходных систем». И они предоставляют крупноформатную таблицу со своей ежедневно поддерживаемой интерпретацией информации. Другими словами: «Я (заказчик) хочу видеть все номера VIN, которые начинаются с "X", сгруппированными под названием "BIG TRUCKS" ("БОЛЬШИЕ ГРУЗОВИКИ")». В Data Vault предусмотрена такая возможность с помощью Набора Пользовательских Группировок (User Grouping Set). Это еще один Хаб (с названием Big Trucks) со Спутником, описывающим номера VIN, группируемые под этим лейблом, и Связь с номерами VIN. Таким образом, сохранены оригинальные данные из исходной системы, в то же время можно получить информацию в манере, соответствующей пользовательским потребностям. Когда все будет сказано и сделано, хранилище данных является успешным, так как оно отвечает потребностям пользователей.


## Основы архитектуры Data Vault
Архитектура уходит корнями в математику сокращения избыточности. Спутники предназначены только для хранения дельты или изменившейся информации. Если один из спутников начинает быстро расти, очень легко создать два новых спутника и запустить процесс, разделяющий дельту; процесс, который будет разделять информацию в два новых спутника, каждый процесс выполняет другой дельта-процесс перед вставкой новых строк. Этот процесс может сократить процент дублирования колоночных данных до минимума. Это приравнивается к использованию меньшего объема хранения. Спутники по своей природе могут быть очень длинными, и в большинстве случаев узкими (имеют не много столбцов). Для сравнения, измерения 2-го типа могут реплицировать данные во многих столбцах, делать копии информации снова и снова, а также создавая новые ключи.

Хабы хранят по одному экземпляру бизнес ключа. Бизнес ключи, как правило, имеют очень низкую склонность к изменениям. Поэтому суррогатные ключи отображаются один к одному на бизнес ключи (если используются суррогаты) и никогда не меняются. Первичный ключ Хаба (независимо от типа - бизнес или суррогатный) является единственным компонентом информации, реплицированным между Спутниками и Связями. Поэтому Спутники всегда привязываются непосредственно к бизнес ключу. Таким образом, Спутникам отводится роль описывать бизнес ключи на наиболее доступном детальном уровне. Это обеспечивает основу для развития контекста, описывающего бизнес.

Другим уникальным результатом Data Vault является возможность динамически представлять отношения. Отношения создаются структурой Связей сразу же как «ассоциированные» бизнес ключи поступают из источника данных. Эта связь существует, пока они не датированы датой окончания (в Спутнике), либо не удалены из набора данных полностью. Тот факт, что эти отношения представлены таким образом, открывает новые возможности в области динамического создания отношений. Если в результате интеллектуального анализа данных обнаружены новые отношения между двумя хабами (или их контекстом), то новые Связи могут быть сформированы автоматически.

Кроме того, структуры Связи и информация могут быть отмечены конечной датой или удалены, когда они утратят свою актуальность. Например: сегодня компания продает продукцию, и имеет таблицу связи между продуктами и счетами-фактурами. Завтра, они начинают продавать услуги. Это очень просто реализуется, путем создания Хаба «Услуги» и связи между счетами и услугами, затем все отношения между товарами и счетами-фактурами датируются как оконченные. В этом примере, процесс изменения модели данных можно начать исследовать с программной точки зрения. Если это автоматизировать, то можно будет динамически изменять и адаптировать структуру хранилища данных, чтобы удовлетворить потребности деловых пользователей.

Темпы изменения и сокращение избыточности наряду с гибкостью потенциально неограниченных динамических изменений отношений формируют мощную основу. Эти слагаемые открывают двери применению структур Data Vault для множества различных целей.

https://youtu.be/fNGIOb8SJvU?t=1404
